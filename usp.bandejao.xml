<?xml version="1.0" encoding="UTF-8"?>
<table xmlns="http://query.yahooapis.com/v1/schema/table.xsd" https="true">
<meta>
    <author>Andrew Kurauchi</author>
    <description>Cardapio do bandejao da USP</description>
    <sampleQuery description="Consulta cardapio do bandejao da quimica para o almoco de segunda feira">select * from {table} where bandejao='quimica' and dia='segunda' and periodo='almoco';</sampleQuery>
</meta>
<bindings>
    <select itemPath="" produces="XML">
        <inputs>  
            <key id='bandejao' type='xs:string' paramType='variable' required="true" />
            <key id='dia' type='xs:string' paramType='variable' required="false" />
            <key id='periodo' type='xs:string' paramType='variable' required="false" />
        </inputs>
        <execute><![CDATA[
            var url = '';
            bandejao = 'central';
            if(bandejao.toLowerCase() == 'central') {
                url = 'http://www.usp.br/coseas/cardapio.html';
            }
            else if(bandejao.toLowerCase() == 'fisica') {
                url = 'http://www.usp.br/coseas/cardapiofisica.html';
            }
            else if(bandejao.toLowerCase() == 'quimica') {
                url = 'http://www.usp.br/coseas/cardapioquimica.html';
            }
            else if(bandejao.toLowerCase() == 'pusp') {
                url = 'http://www.usp.br/coseas/cardcocesp.html';
            }
            else if(bandejao.toLowerCase() == 'doc') {
                url = 'http://www.usp.br/coseas/carddoc.html';
            }
            else if(bandejao.toLowerCase() == 'enf') {
                url = 'http://www.usp.br/coseas/cardEscEnf.html';
            }
            else if(bandejao.toLowerCase() == 'fsp') {
                url = 'http://www.usp.br/coseas/cardFSP.html';
            }
            else if(bandejao.toLowerCase() == 'direito') {
                url = 'http://www.usp.br/coseas/cardFacDireito.html';
            }

            if(url == '') {
                y.exit(204, "Bandejao nao especificado."); 
            }
            var xpath = "//tbody";
            var results = y.query('select * from html where url="' + url + '" and xpath="' + xpath + '"').results;
            
            var firstRow = true;
            for each(var tr in results.tbody.tr) {
                if(firstRow) {
                    firstRow = false;
                    continue;
                }
                var countRef = 0;
                var cardapio = <cardapio></cardapio>
                for(var tdref in tr.td) {
                    var refeicao = <refeicao></refeicao>
                    if(countRef == 0) {
                        refeicao.periodo = 'almoco';
                    }
                    else {
                        refeicao.periodo = 'jantar';
                    }
                    var count = 0;
                    refeicao.inner = tdref;
                    refeicao.dia = tdref.pre.strong.font;
                    for(var p in tdref.p) {
                        if(count == 0) {
                            refeicao.principal = p.span;
                        }
                        else if(count == 1) {
                            refeicao.acompanhamento = p.span;
                        }
                        else if(count == 2) {
                            refeicao.salada = p.span;
                        }
                        else if(count == 3) {
                            refeicao.sobremesa = p.span;
                        }
                        else if(count == 4) {
                            var countB = 0;
                            for(var b in p.b) {
                                if(countB == 0) {
                                    refeicao.bebida = b.span;
                                }
                                else {
                                    refeicao.calorias = b.span;
                                    break;
                                }
                                countB += 1;
                            }
                        }
                        count += 1;
                    }
                    cardapio.cardapio += refeicao;
                    countRef += 1;
                }
            }
            response.object = cardapio;
            
            /*results = query.results;
            responseXML = <cursos></cursos>;
            for each (var tr in results.tr) {
                if(tr.elements('th').length() == 0) {
                    curso = <curso></curso>;
                    for each(var td in tr.td) {
                        if(td.@['class'] == 'curso') {
                            curso.curso += <nome>{td.a.*}</nome>;
                        }
                        if(td.@['class'] == 'data') {
                            curso.curso += <data>{td.p.*}</data>;
                        }
                        if(td.@['class'] == 'periodo') {
                            curso.curso += <periodo>{td.@title}</periodo>;
                        }
                        if(td.@['class'] == 'cidade') {
                            curso.curso += <cidade>{td.p.*}</cidade>;
                        }
                        if(td.@['class'] == 'comentario') {
                            curso.curso += <comentario>{td.p.*}</comentario>;
                        }
                    }
                    responseXML.cursos += curso;
                }
            }
            
            response.object = responseXML;*/
        	]]></execute>
    </select>
</bindings>
</table>