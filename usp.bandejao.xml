<?xml version="1.0" encoding="UTF-8"?>
<table xmlns="http://query.yahooapis.com/v1/schema/table.xsd" https="true">
<meta>
    <author>Andrew Kurauchi</author>
    <description>Cardapio do bandejao da USP</description>
    <sampleQuery description="Consulta cardapio do bandejao da quimica para o almoco de segunda feira">select * from {table} where bandejao='quimica';</sampleQuery>
</meta>
<bindings>
    <select itemPath="" produces="XML">
        <inputs>  
            <key id='bandejao' type='xs:string' paramType='variable' required="true" />
        </inputs>
        <execute><![CDATA[            
            // Adiciona função em string (sim, eh perigoso, mas acho que nesse caso eh aceitavel)
            String.prototype.regexIndexOf = function(regex, startpos) {
                var indexOf = this.substring(startpos || 0).search(regex);
                return (indexOf >= 0) ? (indexOf + (startpos || 0)) : indexOf;
            }
            
            // Verifica se str eh um dia da semana
            function diaValido(str) {
                if(!str) {
                    return false;
                }
                var dias = ["segunda", "terça", "quarta", "quinta", "sexta", "sábado", "domingo"];
                str = str.toLowerCase(); // Normalmente vem no formato "SEGUNDA-FEIRA", etc
                // Compara com todos os dias
                for (var i in dias) {
                    if (str.indexOf(dias[i]) >= 0) {
                        return true;
                    }
                }
                return false;
            }
            
            // Devolve tudo o que não for tag em um array
            function encontraConteudos(strHtml) {
                var conteudos = [];
                while(1) {
                    var inicio = strHtml.regexIndexOf(/>\s*([a-z|A-Z])/); // Procura primeiro fim de tag
                    if (inicio < 0) {
                        break;
                    }
                    strHtml = strHtml.substring(inicio + 1);
                    var fim = strHtml.indexOf("<"); // Procura primeiro comeco de tag
                    if (fim < 0) {
                        break;
                    }
                    // Se chegou aqui eh porque encontrou um conteudo
                    conteudos.push(strHtml.substring(0, fim));
                    strHtml = strHtml.substring(fim + 1); // Prepara pra proxima iteracao
                }
                // Separa quando tiver mais que um \n, senão so remove o \n
                var retval = [];
                for (var i in conteudos) {
                    if (conteudos[i].split("\n").length - 1 > 1) {
                        retval = retval.concat(conteudos[i].split("\n"));
                    }
                    else {
                        retval.push(conteudos[i].replace(/\n/g, ''));
                    }
                }
                // Aplica trim em todas as strings e remove de retval as strings vazias
                retval = retval.map(function(str) {return str.trim()}).filter(function(str) {return str != ""});
                return retval;
            }
            
            // Devolve um array com o conteudo de todas as tags do tipo tag que encontrar
            function encontraTag(strHtml, tag) {
                var tags = [];
                while(1) {
                    // Procura comeco do abre tag
                    var inicio = strHtml.regexIndexOf(new RegExp("<(" + tag.toLowerCase() + "|" + tag.toUpperCase() + ")"));
                    // Procura comeco do fecha tag
                    var fim = strHtml.regexIndexOf(new RegExp("</(" + tag.toLowerCase() + "|" + tag.toUpperCase() + ")"));
                    if (inicio != -1) {
                        inicio = inicio + strHtml.substring(inicio).indexOf(">"); // Procura fim do abre tag
                    }
                    else {
                        inicio = -1;
                        fim = -1;
                    }
                    if (inicio != -1 && fim != -1 && inicio + 1 < fim) {
                        // Encontrou um conteudo
                        tags.push(strHtml.substring(inicio + 1, fim));
                        strHtml = strHtml.substring(fim);
                        fim = strHtml.indexOf(">");
                        strHtml = strHtml.substring(fim + 1);
                    }
                    else {
                        break;
                    }
                }
                return tags;
            }

            var url = '';
            bandejao = bandejao.toLowerCase();
            if(bandejao == 'central') {
                url = 'http://www.usp.br/coseas/cardapio.html';
            }
            else if(bandejao == 'fisica') {
                url = 'http://www.usp.br/coseas/cardapiofisica.html';
            }
            else if(bandejao == 'quimica') {
                url = 'http://www.usp.br/coseas/cardapioquimica.html';
            }
            else if(bandejao == 'pusp') {
                url = 'http://www.usp.br/coseas/cardcocesp.html';
            }
            else if(bandejao == 'doc') {
                url = 'http://www.usp.br/coseas/carddoc.html';
            }
            else if(bandejao == 'enf') {
                url = 'http://www.usp.br/coseas/cardEscEnf.html';
            }
            else if(bandejao == 'fsp') {
                url = 'http://www.usp.br/coseas/cardFSP.html';
            }
            else if(bandejao == 'direito') {
                url = 'http://www.usp.br/coseas/cardFacDireito.html';
            }

            if(url == '') {
                y.exit(204, "Bandejao nao especificado."); 
            }
            var resultHtml = y.rest(url).get().response;
            var dias = encontraTag(resultHtml, "tr");
            dias = dias.slice(1); // Primeiro tr tem os textos ALMOCO e JANTAR
            
            var cardapio = <cardapio></cardapio>
            for (var dia_i in dias) {
                var dia = dias[dia_i];
                var contaRef = 0; // Refeicao 0 eh almoco, 1 eh janta
                var refeicoesHtml = encontraTag(dia, "td"); // Cada td eh uma refeicao
                for (var refeicao_i in refeicoesHtml) {
                    var refeicaoHtml = refeicoesHtml[refeicao_i];
                    var refeicao = <refeicao></refeicao>
                    if(contaRef == 0) {
                        refeicao.periodo = 'almoco';
                    }
                    else {
                        refeicao.periodo = 'jantar';
                    }
                    var conteudos = encontraConteudos(refeicaoHtml);
                    if (diaValido(conteudos[0])) {
                        refeicao.dia = conteudos[0];
                        conteudos = conteudos.slice(1);
                        for (var i in conteudos) {
                            refeicao.cardapio.item += <item>{conteudos[i]}</item>;
                        }
                        cardapio.cardapio += refeicao;
                    }
                    
                    contaRef += 1;
                }
            }
            response.object = cardapio;
            
        	]]></execute>
    </select>
</bindings>
</table>