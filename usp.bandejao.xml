<?xml version="1.0" encoding="UTF-8"?>
<table xmlns="http://query.yahooapis.com/v1/schema/table.xsd" https="true">
<meta>
    <author>Andrew Kurauchi</author>
    <description>Cardapio do bandejao da USP</description>
    <sampleQuery description="Consulta cardapio do bandejao da quimica para o almoco de segunda feira">select * from {table} where bandejao='quimica' and dia='segunda' and periodo='almoco';</sampleQuery>
</meta>
<bindings>
    <select itemPath="" produces="XML">
        <inputs>  
            <key id='bandejao' type='xs:string' paramType='variable' required="true" />
            <key id='dia' type='xs:string' paramType='variable' required="false" />
            <key id='periodo' type='xs:string' paramType='variable' required="false" />
        </inputs>
        <execute><![CDATA[            
            String.prototype.regexIndexOf = function(regex, startpos) {
                var indexOf = this.substring(startpos || 0).search(regex);
                return (indexOf >= 0) ? (indexOf + (startpos || 0)) : indexOf;
            }
            
            function diaValido(str) {
                var dias = ["segunda", "terça", "quarta", "quinta", "sexta", "sábado", "domingo"];
                for (var i in dias) {
                    if (str.indexOf(dias[i].toLowerCase()) >= 0) {
                        return true;
                    }
                }
                return false;
            }
            
            function findContents(htmlString) {
                var contents = [];
                while(1) {
                    var begin = htmlString.regexIndexOf(/>\s*([a-z|A-Z])/);
                    if (begin < 0) {
                        break;
                    }
                    htmlString = htmlString.substring(begin + 1);
                    var end = htmlString.indexOf("<");
                    if (end < 0) {
                        break;
                    }
                    contents.push(htmlString.substring(0, end));
                    htmlString = htmlString.substring(end + 1);
                }
                // Separa quando tiver \n e aplica o trim
                var retval = [];
                for (var i in contents) {
                    retval = retval.concat(contents[i].split("\n"));
                }
                retval = retval.map(function(str) {return str.trim()}).filter(function(str) {return str != ""});
                return retval;
            }
            
            function findTag(htmlString, tag) {
                var tags = [];
                while(1) {
                    var begin = htmlString.indexOf("<" + tag);
                    var end = htmlString.indexOf("</" + tag);
                    if (begin != -1) {
                        begin = begin + htmlString.substring(begin).indexOf(">");
                    }
                    else {
                        begin = -1;
                        end = -1;
                    }
                    if (begin != -1 && end != -1 && begin + 1 < end) {
                        tags.push(htmlString.substring(begin + 1, end));
                        htmlString = htmlString.substring(end);
                        end = htmlString.indexOf(">");
                        htmlString = htmlString.substring(end + 1);
                    }
                    else {
                        break;
                    }
                }
                return tags;
            }

            var url = '';
            if(bandejao.toLowerCase() == 'central') {
                url = 'http://www.usp.br/coseas/cardapio.html';
            }
            else if(bandejao.toLowerCase() == 'fisica') {
                url = 'http://www.usp.br/coseas/cardapiofisica.html';
            }
            else if(bandejao.toLowerCase() == 'quimica') {
                url = 'http://www.usp.br/coseas/cardapioquimica.html';
            }
            else if(bandejao.toLowerCase() == 'pusp') {
                url = 'http://www.usp.br/coseas/cardcocesp.html';
            }
            else if(bandejao.toLowerCase() == 'doc') {
                url = 'http://www.usp.br/coseas/carddoc.html';
            }
            else if(bandejao.toLowerCase() == 'enf') {
                url = 'http://www.usp.br/coseas/cardEscEnf.html';
            }
            else if(bandejao.toLowerCase() == 'fsp') {
                url = 'http://www.usp.br/coseas/cardFSP.html';
            }
            else if(bandejao.toLowerCase() == 'direito') {
                url = 'http://www.usp.br/coseas/cardFacDireito.html';
            }

            if(url == '') {
                y.exit(204, "Bandejao nao especificado."); 
            }
            var result = y.rest(url).get().response;
            trs = findTag(result, "tr");
            
            var firstRow = true;
            var cardapio = <cardapio></cardapio>
            cardapio.cardapio.inner = trs;
            for (var tr_i in trs) {
                var tr = trs[tr_i];
                if(firstRow) {
                    firstRow = false;
                    continue;
                }
                var countRef = 0;
                var tds = findTag(tr, "td");
                for (var td_i in tds) {
                    var td = tds[td_i];
                    var refeicao = <refeicao></refeicao>
                    if(countRef == 0) {
                        refeicao.periodo = 'almoco';
                    }
                    else {
                        refeicao.periodo = 'jantar';
                    }
                    var count = 0;
                    var contents = findContents(td);
                    if (diaValido(contents[0])) {
                        refeicao.dia = contents[0];
                        contents = contents.slice(1);
                        for (var i in contents) {
                            refeicao.cardapio += contents[i];
                        }
                        cardapio.cardapio += refeicao;
                    }
                    
                    countRef += 1;
                }
            }
            response.object = cardapio;
            
        	]]></execute>
    </select>
</bindings>
</table>