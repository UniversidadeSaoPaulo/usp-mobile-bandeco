<?xml version="1.0" encoding="UTF-8"?>
<table xmlns="http://query.yahooapis.com/v1/schema/table.xsd" https="true">
<meta>
    <author>Andrew Kurauchi</author>
    <description>Cardapio do bandejao da USP</description>
    <sampleQuery description="Consulta cardapio do bandejao da quimica para o almoco de segunda feira">select * from {table} where bandejao='quimica' and dia='segunda' and periodo='almoco';</sampleQuery>
</meta>
<bindings>
    <select itemPath="" produces="XML">
        <inputs>  
            <key id='bandejao' type='xs:string' paramType='variable' required="true" />
            <key id='dia' type='xs:string' paramType='variable' required="false" />
            <key id='periodo' type='xs:string' paramType='variable' required="false" />
        </inputs>
        <execute><![CDATA[            
            function findTag(htmlString, tag) {
                var tags = [];
                while(1) {
                    var begin = htmlString.indexOf("<" + tag);
                    var end = htmlString.indexOf("</" + tag);
                    if (begin != -1) {
                        begin = begin + htmlString.substring(begin).indexOf(">");
                    }
                    else {
                        begin = -1;
                        end = -1;
                    }
                    if (begin != -1 && end != -1 && begin + 1 < end) {
                        tags.push(htmlString.substring(begin + 1, end));
                        htmlString = htmlString.substring(end);
                        end = htmlString.indexOf(">");
                        htmlString = htmlString.substring(end + 1);
                    }
                    else {
                        break;
                    }
                }
                return tags;
            }

            var url = '';
            if(bandejao.toLowerCase() == 'central') {
                url = 'http://www.usp.br/coseas/cardapio.html';
            }
            else if(bandejao.toLowerCase() == 'fisica') {
                url = 'http://www.usp.br/coseas/cardapiofisica.html';
            }
            else if(bandejao.toLowerCase() == 'quimica') {
                url = 'http://www.usp.br/coseas/cardapioquimica.html';
            }
            else if(bandejao.toLowerCase() == 'pusp') {
                url = 'http://www.usp.br/coseas/cardcocesp.html';
            }
            else if(bandejao.toLowerCase() == 'doc') {
                url = 'http://www.usp.br/coseas/carddoc.html';
            }
            else if(bandejao.toLowerCase() == 'enf') {
                url = 'http://www.usp.br/coseas/cardEscEnf.html';
            }
            else if(bandejao.toLowerCase() == 'fsp') {
                url = 'http://www.usp.br/coseas/cardFSP.html';
            }
            else if(bandejao.toLowerCase() == 'direito') {
                url = 'http://www.usp.br/coseas/cardFacDireito.html';
            }

            if(url == '') {
                y.exit(204, "Bandejao nao especificado."); 
            }
            var result = y.rest(url).get().response;
            trs = findTag(result, "tr");
            
            var firstRow = true;
            var cardapio = <cardapio></cardapio>
            cardapio.cardapio.inner = trs;
            for (var tr in trs) {
                if(firstRow) {
                    firstRow = false;
                    continue;
                }
                var countRef = 0;
                var tds = findTag(tr, "td");
                cardapio.tds += tds;
                cardapio.trs += trs;
                for (var td in tds) {
                    var refeicao = <refeicao></refeicao>
                    if(countRef == 0) {
                        refeicao.periodo = 'almoco';
                    }
                    else {
                        refeicao.periodo = 'jantar';
                    }
                    var count = 0;
                    var fonts = findTag(td, "font");
                    refeicao.dia = fonts[0];
                    refeicao.comida = fonts[2];
                    
                    cardapio.cardapio += refeicao;
                    countRef += 1;
                    /*for(var p in td.p) {
                        if(count == 0) {
                            refeicao.dia = td.p.b.span;
                        }
                        if(count == 0) {
                            refeicao.principal = p.span;
                        }
                        else if(count == 1) {
                            refeicao.acompanhamento = p.span;
                        }
                        else if(count == 2) {
                            refeicao.salada = p.span;
                        }
                        else if(count == 3) {
                            refeicao.sobremesa = p.span;
                        }
                        else if(count == 4) {
                            var countB = 0;
                            for(var b in p.b) {
                                if(countB == 0) {
                                    refeicao.bebida = b.span;
                                }
                                else {
                                    refeicao.calorias = b.span;
                                    break;
                                }
                                countB += 1;
                            }
                        }
                        count += 1;
                    }*/
                }
            }
            response.object = cardapio;
            
        	]]></execute>
    </select>
</bindings>
</table>